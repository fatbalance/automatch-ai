<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AutoMatch AI</title>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:#0b0b0b;
      color:#fff;
    }

    header{
      padding:26px 40px;
      border-bottom:1px solid #1e1e1e;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:650;letter-spacing:.2px}
    .dot{width:10px;height:10px;border-radius:999px;background:#fff;opacity:.9}
    .hint{color:#8a8a8a;font-size:14px}

    main{
      max-width:1040px;
      margin:0 auto;
      padding:64px 30px 120px;
    }

    .hero{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:24px;
      margin-bottom:26px;
    }
    .hero h1{
      margin:0;
      font-size:52px;
      line-height:1.05;
      letter-spacing:-.03em;
    }
    .hero p{
      margin:0;
      max-width:520px;
      color:#b3b3b3;
      font-size:16px;
      line-height:1.6;
    }

    .layout{
      display:grid;
      grid-template-columns:1.25fr .75fr;
      gap:18px;
      margin-top:26px;
    }

    .panel{
      background:#101010;
      border:1px solid #1f1f1f;
      border-radius:20px;
      padding:22px;
    }
    .panel h2{margin:0 0 10px;font-size:18px;font-weight:650;letter-spacing:-.01em}
    .panel .sub{margin:0 0 16px;color:#9a9a9a;font-size:14px;line-height:1.5}

    .q{padding:16px 0;border-top:1px solid #1e1e1e}
    .q:first-of-type{border-top:0;padding-top:6px}
    .qtitle{display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin-bottom:10px}
    .qtitle b{font-size:14px;color:#e6e6e6;font-weight:600}
    .qtitle span{font-size:12px;color:#8a8a8a}

    .row{display:flex;gap:12px;flex-wrap:wrap}

    /* chips */
    .chip{
      border:1px solid #2a2a2a;
      background:#0b0b0b;
      color:#e7e7e7;
      border-radius:999px;
      padding:10px 14px;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:10px;
      transition:transform .12s ease,border-color .12s ease,background .12s ease,opacity .12s ease;
    }
    .chip:hover{transform:translateY(-1px);border-color:#3a3a3a}
    .chip:active{transform:translateY(0);opacity:.92}

    .tick{
      width:16px;height:16px;border-radius:6px;
      border:1px solid #3a3a3a;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:12px;color:#0b0b0b;background:transparent;
      transition:background .12s ease,border-color .12s ease,color .12s ease;
    }

    input[type="checkbox"]{display:none}
    input[type="checkbox"]:checked + label.chip{
      border-color:#e5e7eb;
      background:rgba(255,255,255,.06);
    }
    input[type="checkbox"]:checked + label.chip .tick{
      background:#e5e7eb;border-color:#e5e7eb;color:#0b0b0b;
    }

    .money{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .money input{
      width:260px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid #2a2a2a;
      background:#0b0b0b;
      color:#fff;
      font-size:15px;
    }
    .money small{color:#8a8a8a;font-size:12px}

    textarea{
      width:100%;
      padding:14px;
      border-radius:16px;
      border:1px solid #2a2a2a;
      background:#0b0b0b;
      color:#fff;
      font-size:14px;
      min-height:92px;
      resize:vertical;
    }

    .actions{
      margin-top:18px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .btn{
      padding:14px 18px;
      border-radius:16px;
      border:1px solid #2a2a2a;
      background:#0b0b0b;
      color:#fff;
      font-weight:650;
      cursor:pointer;
      transition:transform .12s ease,opacity .12s ease,border-color .12s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .btn:hover{transform:translateY(-1px);border-color:#3a3a3a}
    .btn:active{transform:translateY(0);opacity:.92}
    .btn.primary{background:#fff;color:#0b0b0b;border-color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}

    .summary{position:sticky;top:18px;height:fit-content}
    .summary .box{
      background:#0e0e0e;
      border:1px solid #1f1f1f;
      border-radius:20px;
      padding:18px;
    }
    .summary h3{margin:0 0 8px;font-size:14px;color:#d6d6d6;font-weight:650}
    .summary .meta{color:#8a8a8a;font-size:12px;margin-bottom:12px;line-height:1.4}
    .summary pre{margin:0;white-space:pre-wrap;color:#bdbdbd;font-size:13px;line-height:1.5}

    .results{margin-top:18px;display:none;animation:fadeIn .25s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    .reply{
      border:1px solid #1f1f1f;
      background:#0e0e0e;
      border-radius:20px;
      padding:16px;
      color:#e6e6e6;
      line-height:1.65;
      font-size:14px;
      overflow-wrap:anywhere;
    }
    /* While typing, we show plain text */
    .reply pre{
      margin:0;
      white-space:pre-wrap;
      font: inherit;
      color: inherit;
      line-height:1.65;
    }

    /* After formatting */
    .reply .h{
      margin:10px 0 6px;
      font-weight:750;
      color:#f3f4f6;
    }
    .reply ul{margin:8px 0 12px 18px;padding:0}
    .reply li{margin:6px 0;color:#dedede}
    .reply .muted{color:#a3a3a3}

    .error{
      border:1px solid #3a1f1f;
      background:#120909;
      border-radius:18px;
      padding:14px;
      color:#ffd0d0;
      font-size:13px;
      white-space:pre-wrap;
      line-height:1.55;
      margin-bottom:12px;
      display:none;
    }

    .loader{display:inline-flex;align-items:center;gap:10px;color:#bdbdbd}
    .dots span{
      display:inline-block;width:6px;height:6px;border-radius:999px;
      background:#bdbdbd;opacity:.25;animation:pulse 1s infinite;
    }
    .dots span:nth-child(2){animation-delay:.15s}
    .dots span:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%,100%{opacity:.25;transform:translateY(0)}50%{opacity:1;transform:translateY(-2px)}}

    .caret{
      display:inline-block;
      width:8px;
      height:16px;
      background:#e5e7eb;
      margin-left:6px;
      border-radius:2px;
      transform:translateY(2px);
      animation:blink 1s infinite;
    }
    @keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0}}

    @media (max-width:900px){
      .layout{grid-template-columns:1fr}
      .summary{position:static}
      .hero{flex-direction:column;align-items:flex-start}
      .hero h1{font-size:42px}
    }
  </style>
</head>

<body>
<header>
  <div class="brand"><span class="dot"></span> AutoMatch AI</div>
  <div class="hint">Powered by Groq</div>
</header>

<main>
  <section class="hero">
    <div><h1>Find the right car<br/>for your life.</h1></div>
    <p>
      Pick what applies. The more you select, the better the match.
      We’ll recommend UK-friendly options and explain why.
    </p>
  </section>

  <section class="layout">
    <div class="panel">
      <h2>Your preferences</h2>
      <p class="sub">Budget, type, usage, priorities, notes. Multi-select on everything.</p>

      <div class="q">
        <div class="qtitle"><b>Budget</b><span>cash or monthly is fine</span></div>
        <div class="money">
          <input id="budget" placeholder="£12,000 or £350 / mo" />
          <small>Optional</small>
        </div>
      </div>

      <div class="q">
        <div class="qtitle"><b>Car type</b><span>select all that apply</span></div>
        <div class="row">
          <input id="t_hatch" type="checkbox" value="Hatchback"><label class="chip" for="t_hatch"><span class="tick">✓</span>Hatchback</label>
          <input id="t_suv" type="checkbox" value="SUV"><label class="chip" for="t_suv"><span class="tick">✓</span>SUV</label>
          <input id="t_saloon" type="checkbox" value="Saloon"><label class="chip" for="t_saloon"><span class="tick">✓</span>Saloon</label>
          <input id="t_estate" type="checkbox" value="Estate"><label class="chip" for="t_estate"><span class="tick">✓</span>Estate</label>
          <input id="t_coupe" type="checkbox" value="Coupe"><label class="chip" for="t_coupe"><span class="tick">✓</span>Coupe</label>
          <input id="t_electric" type="checkbox" value="Electric"><label class="chip" for="t_electric"><span class="tick">✓</span>Electric</label>
          <input id="t_hybrid" type="checkbox" value="Hybrid"><label class="chip" for="t_hybrid"><span class="tick">✓</span>Hybrid</label>
        </div>
      </div>

      <div class="q">
        <div class="qtitle"><b>Main use</b><span>select all that apply</span></div>
        <div class="row">
          <input id="u_commute" type="checkbox" value="Daily commuting"><label class="chip" for="u_commute"><span class="tick">✓</span>Daily commuting</label>
          <input id="u_city" type="checkbox" value="City driving"><label class="chip" for="u_city"><span class="tick">✓</span>City driving</label>
          <input id="u_motorway" type="checkbox" value="Long motorway trips"><label class="chip" for="u_motorway"><span class="tick">✓</span>Long motorway trips</label>
          <input id="u_family" type="checkbox" value="Family use"><label class="chip" for="u_family"><span class="tick">✓</span>Family use</label>
          <input id="u_first" type="checkbox" value="First car"><label class="chip" for="u_first"><span class="tick">✓</span>First car</label>
          <input id="u_fun" type="checkbox" value="Fun / performance"><label class="chip" for="u_fun"><span class="tick">✓</span>Fun / performance</label>
        </div>
      </div>

      <div class="q">
        <div class="qtitle"><b>Priorities</b><span>select all that apply</span></div>
        <div class="row">
          <input id="p_reliable" type="checkbox" value="Reliability"><label class="chip" for="p_reliable"><span class="tick">✓</span>Reliability</label>
          <input id="p_costs" type="checkbox" value="Low running costs"><label class="chip" for="p_costs"><span class="tick">✓</span>Low running costs</label>
          <input id="p_ins" type="checkbox" value="Low insurance"><label class="chip" for="p_ins"><span class="tick">✓</span>Low insurance</label>
          <input id="p_comfort" type="checkbox" value="Comfort"><label class="chip" for="p_comfort"><span class="tick">✓</span>Comfort</label>
          <input id="p_tech" type="checkbox" value="Technology"><label class="chip" for="p_tech"><span class="tick">✓</span>Technology</label>
          <input id="p_perf" type="checkbox" value="Performance"><label class="chip" for="p_perf"><span class="tick">✓</span>Performance</label>
          <input id="p_space" type="checkbox" value="Boot space"><label class="chip" for="p_space"><span class="tick">✓</span>Boot space</label>
          <input id="p_ulez" type="checkbox" value="ULEZ friendly"><label class="chip" for="p_ulez"><span class="tick">✓</span>ULEZ friendly</label>
        </div>
      </div>

      <div class="q">
        <div class="qtitle"><b>Anything else</b><span>optional</span></div>
        <textarea id="notes" placeholder="Brands you like/dislike, insurance concerns, mileage, must-have features…"></textarea>

        <div class="actions">
          <button class="btn" type="button" onclick="resetAll()">Reset</button>
          <button id="matchBtn" class="btn primary" type="button" onclick="match()">
            Match me with a car
          </button>
        </div>
      </div>
    </div>

    <aside class="summary">
      <div class="box">
        <h3>Live summary</h3>
        <div class="meta">This is what we send to the AI.</div>
        <pre id="out">Select a few chips to start…</pre>
      </div>
    </aside>
  </section>

  <section id="results" class="panel results">
    <h2>Your AI result</h2>
    <p class="sub" id="resultsSub">Based on your picks.</p>
    <div id="errBox" class="error"></div>
    <div id="aiReply" class="reply"></div>
  </section>
</main>

<script>
  const out = document.getElementById("out");
  const budget = document.getElementById("budget");
  const notes = document.getElementById("notes");
  const matchBtn = document.getElementById("matchBtn");

  const results = document.getElementById("results");
  const resultsSub = document.getElementById("resultsSub");
  const aiReply = document.getElementById("aiReply");
  const errBox = document.getElementById("errBox");

  const allChecks = () => Array.from(document.querySelectorAll('input[type="checkbox"]'));
  const selected = () => allChecks().filter(c => c.checked).map(c => c.value);

  let activeController = null;

  function renderText() {
    const picks = selected();
    const b = budget.value?.trim();
    const n = notes.value?.trim();

    out.textContent =
`Budget: ${b || "—"}
Selected (${picks.length}):
${picks.length ? "- " + picks.join("\n- ") : "—"}

Notes: ${n || "—"}`;
  }

  function renderLoading() {
    out.innerHTML = `<span class="loader">Matching<span class="dots"><span></span><span></span><span></span></span></span>`;
  }

  function showError(message) {
    errBox.style.display = "block";
    errBox.textContent = message;
  }
  function clearError() {
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function resetAll() {
    if (activeController) activeController.abort();
    activeController = null;

    budget.value = "";
    notes.value = "";
    allChecks().forEach(c => c.checked = false);
    results.style.display = "none";
    aiReply.innerHTML = "";
    clearError();
    matchBtn.disabled = false;
    matchBtn.textContent = "Match me with a car";
    renderText();
  }

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function formatReplyToHtml(text) {
    const lines = (text || "").split("\n");
    let html = "";
    let inList = false;

    const closeList = () => { if (inList) { html += "</ul>"; inList = false; } };

    for (let raw of lines) {
      const t = raw.trim();

      if (!t) { closeList(); html += `<div style="height:10px"></div>`; continue; }

      if (/^[-*•]\s+/.test(t)) {
        if (!inList) { html += "<ul>"; inList = true; }
        html += `<li>${escapeHtml(t.replace(/^[-*•]\s+/, ""))}</li>`;
        continue;
      }

      closeList();

      if (/^\d+\.\s+/.test(t)) {
        html += `<div class="h">${escapeHtml(t)}</div>`;
        continue;
      }

      if (t.length <= 48 && /:$/.test(t)) {
        html += `<div class="h">${escapeHtml(t.replace(/:$/, ""))}</div>`;
        continue;
      }

      html += `<div>${escapeHtml(t)}</div>`;
    }

    closeList();
    return html;
  }

  // FAST typewriter: updates textContent in batches per frame, then formats once at the end.
  function typewriter(el, fullText, { cps = 55 } = {}) {
    return new Promise((resolve) => {
      el.innerHTML = "";
      const pre = document.createElement("pre");
      el.appendChild(pre);

      const caret = document.createElement("span");
      caret.className = "caret";
      el.appendChild(caret);

      let i = 0;
      let last = performance.now();

      function tick(now) {
        const dt = Math.max(0, now - last);
        last = now;

        // chars per ms
        const cpm = cps / 1000;
        const toAdd = Math.max(1, Math.floor(dt * cpm * 1.8)); // slightly faster than cps feels nicer

        i = Math.min(fullText.length, i + toAdd);
        pre.textContent = fullText.slice(0, i);

        if (i < fullText.length) {
          requestAnimationFrame(tick);
        } else {
          caret.remove();
          resolve();
        }
      }

      requestAnimationFrame(tick);
    });
  }

  async function match() {
    const picks = selected();

    if (picks.length < 3) {
      out.textContent = "Pick at least 3 chips so we can match you properly.";
      out.parentElement.animate(
        [{ transform: "translateX(0px)" }, { transform: "translateX(-6px)" }, { transform: "translateX(6px)" }, { transform: "translateX(0px)" }],
        { duration: 220, easing: "ease-out" }
      );
      return;
    }

    // Cancel any in-flight request (prevents the page feeling stuck)
    if (activeController) activeController.abort();
    activeController = new AbortController();

    clearError();
    results.style.display = "none";
    aiReply.innerHTML = "";

    renderLoading();
    matchBtn.disabled = true;
    matchBtn.textContent = "Matching…";

    try {
      const payload = {
        budget: budget.value.trim(),
        picks,
        notes: notes.value.trim()
      };

      const r = await fetch("/api/match", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        signal: activeController.signal
      });

      const data = await r.json();

      matchBtn.disabled = false;
      matchBtn.textContent = "Match me with a car";
      renderText();

      resultsSub.textContent = `Based on: ${picks.slice(0, 7).join(", ")}${picks.length > 7 ? "…" : ""}`;
      results.style.display = "block";
      results.scrollIntoView({ behavior: "smooth", block: "start" });

      if (!r.ok) {
        showError(JSON.stringify(data, null, 2));
        return;
      }

      const reply = data.reply || "No reply returned.";

      // Type out quickly (no heavy formatting while typing)
      await typewriter(aiReply, reply, { cps: 65 });

      // Now format once (clean + fast)
      aiReply.innerHTML = formatReplyToHtml(reply);

    } catch (e) {
      matchBtn.disabled = false;
      matchBtn.textContent = "Match me with a car";
      renderText();

      if (e?.name === "AbortError") {
        // user clicked again; ignore
        return;
      }

      results.style.display = "block";
      resultsSub.textContent = "Network error (see error).";
      showError(e?.message || String(e));
      results.scrollIntoView({ behavior: "smooth", block: "start" });
    } finally {
      activeController = null;
    }
  }

  document.addEventListener("change", (e) => {
    if (e.target.matches('input[type="checkbox"]')) renderText();
  });
  budget.addEventListener("input", renderText);
  notes.addEventListener("input", renderText);

  renderText();
</script>

</body>
</html>

